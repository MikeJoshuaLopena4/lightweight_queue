<html>
<body style="background-color: black; color: red; overflow: hidden">
<div>
<div style="font-size: 60pt">Now Serving:</div>
<div style="width: 100vw;"><span style="display: block; font-size: 80vh; width: 100vw; text-align:center" id="now_serving" >1</span></div>
<div style="display: none"><canvas id="myCanvas" width="384" height="384"></canvas></div>
<input type=button onclick="drawTicket('',99);" style="position: absolute; bottom: 0px" value="." />
</div>

<script>
var server = "192.168.0.105"; //your ip address
var senior = [];
var regular = [];
var maxRegular = 0;
var maxSenior = 0;
const savedEpoch = parseInt(localStorage.getItem("timestamp"), 10) || 0 ;
if (savedEpoch !=0 ) {
	const savedDayOfMonth = new Date(savedEpoch).getDate();
	const dayOfMonth = new Date().getDate();

	if ( savedDayOfMonth == dayOfMonth ) {
		eval("var senior = "+localStorage.getItem("senior"));
		eval("var regular = "+localStorage.getItem("regular"));
		
		if (!Array.isArray(senior)) senior=[];
		if (!Array.isArray(regular)) regular=[];
		
		document.getElementById('now_serving').innerHTML = (senior.length>0?"P"+(senior[0]-1): regular.length>0? (regular[0]-1): '');
	}
	console.log(senior,regular);
}

QConnect('ws://'+server+':81/queue');

function QConnect(ws_addr_port) {
    console.log("connecting ... ");
    if (typeof ws00+'' == 'undefined' || !ws00) {
        console.log('socket connect to '+ws_addr_port);
        ws00 = new WebSocket(ws_addr_port);

        // ðŸ”¹ when socket opens
        ws00.onopen = function() {
            console.log("Connected to server");

            // clear old ping timer if any
            if (ws00.pingInterval) clearInterval(ws00.pingInterval);

            // ðŸ”¹ send keepalive ping every 30 seconds
            ws00.pingInterval = setInterval(() => {
                if (ws00 && ws00.readyState === WebSocket.OPEN) {
                    ws00.send("ping");
                }
            }, 30000);
        };

        // ðŸ”¹ message handler
        ws00.onmessage = function($e) {
            console.log($e.data);    
            switch( $e.data.trim() ) {
                case '1':
                    if (senior.length) senior.push(senior[senior.length-1]+1); else senior.push( maxSenior + 1 );									
                    localStorage.setItem("senior",JSON.stringify(senior));
                    localStorage.setItem("timestamp",Date.now().toString());
                    drawTicket("S",senior[senior.length-1]);
                    break;
                case '2':
                    if (regular.length) regular.push(regular[regular.length-1]+1); else regular.push( maxRegular + 1);
                    localStorage.setItem("regular",JSON.stringify(regular));
                    localStorage.setItem("timestamp",Date.now().toString());
                    drawTicket("",regular[regular.length-1]);
                    break;
                case '3':
                    if (senior.length) {
                        maxSenior = senior.shift();
                        document.getElementById('now_serving').innerHTML = "P"+maxSenior;
                        localStorage.setItem("senior",JSON.stringify(senior));
                        localStorage.setItem("timestamp",Date.now().toString());
                    } else if (regular.length) {
                        maxRegular = regular.shift();
                        document.getElementById('now_serving').innerHTML = maxRegular;
                        localStorage.setItem("regular",JSON.stringify(regular));
                        localStorage.setItem("timestamp",Date.now().toString());
                    }
                    break;
                case '4':							
                    senior=[];
                    regular=[];
                    localStorage.setItem("senior",JSON.stringify(senior));
                    localStorage.setItem("regular",JSON.stringify(regular));
                    localStorage.setItem("timestamp",Date.now().toString());
                    break;
            }
            console.log(senior, regular);
        };

        // ðŸ”¹ reconnect on close
        ws00.onclose = function(e) { 
            console.log('Socket closed. Reconnect in 1s.', e.reason); 
            if (ws00 && ws00.pingInterval) clearInterval(ws00.pingInterval);
            ws00 = null; 
            setTimeout(() => QConnect(ws_addr_port), 1000);
        };

        // ðŸ”¹ handle errors
        ws00.onerror = function(err) { 
            console.error('Socket encountered error: ', err.message, 'Closing socket'); 
            ws00.close(); 
        };
    }
}

function toMonochrome(data, width, height) {
  const mono = [];
  for (let y = 0; y < height; y++) {
    for (let x = 0; x < width; x++) {
      const i = (y * width + x) * 4;
      const luminance = 0.3 * data[i] + 0.59 * data[i+1] + 0.11 * data[i+2];
      mono.push(luminance < 128 ? 1 : 0);
    }
  }
  return mono;
}

function packRaster(mono, width, height) {
  const bytesPerRow = Math.ceil(width / 8);
  const xL = bytesPerRow & 0xFF;
  const xH = (bytesPerRow >> 8) & 0xFF;
  const yL = height & 0xFF;
  const yH = (height >> 8) & 0xFF;

  const header = [0x1D, 0x76, 0x30, 0x00, xL, xH, yL, yH];
  const body = [];

  for (let y = 0; y < height; y++) {
    for (let x = 0; x < bytesPerRow; x++) {
      let byte = 0;
      for (let bit = 0; bit < 8; bit++) {
        const xx = x * 8 + bit;
        const i = y * width + xx;
        if (xx < width && mono[i]) byte |= (0x80 >> bit);
      }
      body.push(byte);
    }
  }

  return new Uint8Array([...header, ...body]);
}

function drawTicket($p,$n) {
	const now = new Date();
	const formatted = now.toLocaleString("en-US", {
      year: "numeric",
      month: "short",
      day: "numeric",
      hour: "2-digit",
      minute: "2-digit",
      hour12: true
	});

	const canvas = document.getElementById("myCanvas");
	const ctx = canvas.getContext("2d");

	// Fill background white
	ctx.fillStyle = "#FFFFFF";
	ctx.fillRect(0, 0, canvas.width, canvas.height);
	
	ctx.fillStyle = "#000000";
	ctx.font = "bold 20px Arial";
	ctx.textAlign = "center";
	ctx.textBaseline = "top";

	// Header text
	ctx.fillText("Chester Enterprises", canvas.width / 2, 50);
	ctx.fillText(formatted, canvas.width / 2, 80);

	// Ticket number
	ctx.fillStyle = "#000000";
	ctx.font = "bold 150px Arial";
	ctx.textAlign = "center";
	ctx.textBaseline = "top";
	ctx.fillText($n, canvas.width / 2, 120);
	
	if ($p=="S") {
		ctx.fillStyle = "#000000";
		ctx.font = "bold 20px Arial";
		ctx.textAlign = "center";
		ctx.textBaseline = "top";
		ctx.fillText("Senior/PWD", canvas.width / 2, 250);
	}

	const imageData = ctx.getImageData(0,0,canvas.width, canvas.height);
	const monoData = toMonochrome(imageData.data, canvas.width, canvas.height);
	const escposData = packRaster(monoData, canvas.width, canvas.height);

	fetch("http://"+server+":8080/print", {
		method: "POST",
		headers: { "Content-Type": "application/octet-stream" },
		body: new Uint8Array(escposData)
	});
}
</script>
</body>
</html>
